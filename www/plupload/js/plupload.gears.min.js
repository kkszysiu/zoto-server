(function(b){var d={},c=true;function a(g,j,e,l,k){var f,h,i;h=google.gears.factory.create("beta.canvas");h.decode(g);scale=Math.min(j/h.width,e/h.height);if(scale<1){j=Math.round(h.width*scale);e=Math.round(h.height*scale)}else{j=h.width;e=h.height}h.resize(j,e);return h.encode(k,{quality:l/100})}b.runtimes.Gears=b.addRuntime("gears",{init:function(g,i){var h;if(!window.google||!google.gears){return i({success:false})}try{h=google.gears.factory.create("beta.desktop")}catch(e){return i({success:false})}function f(l){var k,j,m=[],n;for(j=0;j<l.length;j++){k=l[j];n=b.guid();d[n]=k.blob;m.push(new b.File(n,k.name,k.blob.length))}g.trigger("FilesAdded",m)}g.bind("PostInit",function(){var k=g.settings,j=document.getElementById(k.drop_element);if(j){b.addEvent(j,"dragover",function(l){l.preventDefault()});b.addEvent(j,"drop",function(m){var l=h.getDragData(m,"application/x-gears-files");if(l){f(l.files)}m.preventDefault()});j=0}b.addEvent(document.getElementById(k.browse_button),"click",function(p){var o=[],m,l,n;p.preventDefault();for(m=0;m<k.filters.length;m++){n=k.filters[m].extensions.split(",");for(l=0;l<n.length;l++){o.push("."+n[l])}}h.openFiles(f,{singleFile:!k.multi_selection,filter:o})})});g.bind("UploadFile",function(j,o){var n=0,q,p,m=0,l=j.settings.resize;p=j.settings.chunk_size;q=Math.ceil(o.size/p);if(l&&/\.(png|jpg|jpeg)$/i.test(o.name)){d[o.id]=a(d[o.id],l.width,l.height,l.quality||90,/\.png$/i.test(o.name)?"image/png":"image/jpeg")}o.size=d[o.id].length;k();function k(){var r=j.settings.url,s,t;if(o.status==b.DONE||o.status==b.FAILED||j.state==b.STOPPED){return}t=Math.min(p,o.size-(n*p));s=google.gears.factory.create("beta.httprequest");s.open("POST",r+(r.indexOf("?")==-1?"?":"&")+"name="+escape(o.target_name||o.name)+"&chunk="+n+"&chunks="+q);s.setRequestHeader("Content-Disposition",'attachment; filename="'+o.name+'"');s.setRequestHeader("Content-Type","application/octet-stream");s.upload.onprogress=function(u){o.loaded=m+u.loaded;j.trigger("UploadProgress",o)};s.onreadystatechange=function(){var u;if(s.readyState==4){if(s.status==200){u={file:o,chunk:n,chunks:q,response:s.responseText};j.trigger("ChunkUploaded",u);if(u.cancelled){o.status=b.FAILED;j.trigger("FileUploaded",o);return}m+=t;if(++n>=q){o.status=b.DONE;j.trigger("FileUploaded",o)}else{k()}}else{j.trigger("UploadChunkError",{file:o,chunk:n,chunks:q,error:"Status: "+s.status})}}};if(n<q){s.send(d[o.id].slice(n*p,t))}}});g.features={dragdrop:c,jpgresize:c,pngresize:c,chunks:c};i({success:c})}})})(plupload);